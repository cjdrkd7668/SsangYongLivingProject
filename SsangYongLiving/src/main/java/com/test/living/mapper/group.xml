<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="group">

	<!-- 페이징 처리 전!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->
	<!-- 커뮤니티 글 목록을 가져온다. -->
	<select id="communityList" parameterType="groupCommunityDto" resultType="groupCommunityDto">
		select * from (select rownum as rnum, c.* from (select * from vwCommunity where postSeq = #{postSeq} order by regDate desc) c)
where rnum between #{nowPage} and #{nowPage} + 10
	</select>
	
	<!-- 커뮤니티 특정 글의 정보를 가져온다. -->
	<select id="communityView" parameterType="String" resultType="groupCommunityDto">
		select
		    seq,
		    postSeq,
		    (select name from tblGroupBuyingCompany where seq = (select companySeq from tblGroupBuyingPost where seq = tblCommunity.postSeq)) as companyName,
		    (select subject from tblGroupBuyingPost where seq = tblCommunity.postSeq) as postSubject,
		    (select name from tblMember where seq = tblCommunity.memberSeq) as memberName,
		    memberSeq,
		    subject,
		    detail,
		    to_char(regDate, 'mm/dd hh24:mi') as regDate,
		    (sysdate- regDate) * 24 as gap,
		    to_char(updateDate, 'mm/dd hh24:mi') as updateDate,
		    recCount,
		    readCount,
		    (select count(*) from tblCommunityComment where communitySeq = #{seq}) as commentCount,
		    delFlag
		from tblCommunity where seq = #{seq}
	</select>
	
	<!-- 커뮤니티 특정 글의 댓글 목록을 가져온다. -->
	<select id="communityCommentList" parameterType="String" resultType="groupCommunityCommentDto">
		select
		    seq,
		    pseq,
		    communitySeq,
		    memberSeq,
		    (select name from tblMember where seq = tblCommunityComment.memberSeq and delFlag = 0) as memberName,
		    detail,
		    level,
		    to_char(regDate, 'mm/dd hh24:mi') as regDate,
		    (sysdate- regDate) * 24 as gap,
		    to_char(updateDate, 'mm/dd hh24:mi') as updateDate,
		    delFlag
		from tblCommunityComment
		    where delFlag = 0 and communitySeq = #{seq}
		            start with pseq is null
		                connect by prior seq = pseq
	</select>
	
	<!-- 회원 이름을 가져온다. -->
	<select id="memberName" parameterType="String" resultType="String">
		select name as memberName from tblMember where seq = #{seq}
	</select>
	
	<!-- 특정 공동구매 글의 정보를 가져온다. -->
	<select id="groupBuyingPost" parameterType="String" resultType="groupBuyingPostDto">
		select 
		    seq,
		    companySeq,
		    (select name from tblGroupBuyingCompany where seq = tblGroupBuyingPost.companySeq) as companyName,
		    (select count(*) from tblGroupBuyingPost where companySeq = (select companySeq from tblGroupBuyingPost where seq = #{seq}) and state = 1 and delFlag = 0) as companyCount,
		    (select address from tblGroupBuyingCompany where seq = tblGroupBuyingPost.companySeq) as companyAddress,
		    to_char((select lastTime from tblGroupBuyingCompany where seq = tblGroupBuyingPost.companySeq), 'mm/dd hh24:mi') as companyLastTime,
		    subject,
		    detail,
		    url,
		    price,
		    rate,
		    minCount,
		    salesCount,
		    totalCount,
		    to_char(startDate, 'mm/dd hh24:mi') as startDate,
		    to_char(endDate, 'mm/dd hh24:mi') as endDate,
		    (to_date(endDate, 'yyyy-mm-dd hh24:mi:ss') - to_date(sysdate, 'yyyy-mm-dd hh24:mi:ss')) as timeRemaining,
		    state,
		    delFlag
		from tblGroupBuyingPost where seq = #{seq} and delFlag = 0
	</select>
	
	<!-- Qna 글 목록을 가져온다. -->
	<select id="qnaList" parameterType="groupQnaDto" resultType="groupQnaDto">
		select
		    a.seq as seq,
		    a.postSeq as postSeq,
		    a.companySeq as companySeq,
		    case
		        when a.companySeq is null then (select name from tblMember where seq = a.memberSeq)
		        when a.memberSeq is null then (select name from tblGroupBuyingCompany where seq = a.companySeq)
		    end as name,
		    a.memberSeq as memberSeq,
		    a.subject as subject,
		    to_char(a.regDate, 'mm/dd hh24:mi') as regDate,
		    (sysdate - a.regDate) * 24 as gap,
		    to_char(a.updateDate, 'mm/dd hh24:mi') as updateDate,
		    a.readcount as readCount,
		    a.fileName as fileName,
		    a.openFlag as openFlag
		from (select rownum as rnum, q.* from (select * from tblQna where delFlag = 0 and postSeq = #{postSeq} order by thread desc) q) a
		    where rnum between (#{nowPage}-1)*6+1 and #{nowPage}*6
	</select>
	
</mapper>
